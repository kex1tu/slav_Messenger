
# Архитектура проекта: Чат-клиент (Версия 4)

## 1. Общее видение и принципы

Версия 4 представляет собой зрелую архитектуру для десктопного мессенджера, построенную на принципах **производительности, отзывчивости и масштабируемости**. В основе лежат проверенные временем паттерны проектирования и ключевые возможности фреймворка Qt, что обеспечивает четкое разделение ответственности между компонентами.

### Ключевые архитектурные принципы:

1.  **Централизованный контроллер (Orchestrator):** Класс `MainWindow` выступает в роли единого "мозгового центра". Он управляет сетевым взаимодействием, состоянием приложения и кэшем данных, в то время как остальные UI-компоненты остаются "пассивными" и занимаются исключительно отображением и отправкой сигналов о действиях пользователя.

2.  **Разделение данных и представления (Model-View-Delegate):** Паттерн MVD используется в двух критически важных местах:
    *   **Для списка сообщений:** Обеспечивает высочайшую производительность при рендеринге сложных кастомных элементов чата.
    *   **Для списка контактов:** Позволяет легко добавлять кастомные элементы UI (например, счетчики непрочитанных сообщений), не изменяя логику самого виджета.

3.  **Асинхронность и слабая связанность (Signals & Slots):** Все взаимодействие между компонентами построено на механизме сигналов и слотов Qt. Это гарантирует, что компоненты не зависят от внутренней реализации друг друга, а UI никогда не "зависает" во время сетевых операций или обработки данных.

4.  **Кэширование в оперативной памяти (In-Memory Caching):** Для обеспечения мгновенного отклика при переключении между чатами реализован слой кэширования, который хранит уже загруженные истории переписок.

---

## 2. Диаграмма архитектуры

```
+--------------------------------------------------------------------------------+
|                                  MainWindow                                    |
| (Центральный контроллер / Orchestrator)                                        |
|--------------------------------------------------------------------------------|
| - QTcpSocket (Сеть)                                                            |
| - m_responseHandlers (Обработка протокола)                                     |
| - m_chatHistoryCache (КЭШ ИСТОРИИ ЧАТОВ)                                       |
| - m_unreadCounts (Счетчики непрочитанных)                                      |
| - m_userCache (Кэш данных пользователей)                                       |
| - m_currentUsername, m_currentChatPartner (Состояние)                          |
+--------------------------------------------------------------------------------+
      ^                |                 |                |                 |
      | Сигналы        | Прямые вызовы   | Сигналы        | Прямые вызовы   |
      | от виджетов    | методов виджетов| от модели      | к модели        |
      v                v                 v                v                 v
+--------------+  +-------------------+  +--------------------+  +--------------------+
| LoginWidget  |  | ChatViewWidget    |  | ChatMessageModel   |  | QListWidget        |
| (UI Входа)   |  | (UI Чата)         |  | (Данные чата)      |  | (UI Контактов)     |
|--------------|  |-------------------|  |--------------------|  |--------------------|
|->loginReq()  |  |->sendMessageReq()|  |->msgNeedsReceipt() |  | - ItemDelegate ->  |
|->registerReq()|  |->editMsgReq()   |  |                    |  | ContactListDelegate|
+--------------+  |->replyReq()     |  +--------------------+  +--------------------+
                  |                   |
                  | - SmoothListView  |
                  | - replyWidget     |
                  | - scrollToBtmBtn  |
                  +-------------------+
                         ^
                         | Рендеринг
                         v
                  +-------------------+
                  |ChatMessageDelegate|
                  | (Отрисовка        |
                  | сообщений)        |
                  +-------------------+
```

---

## 3. Компонентный разбор

### 3.1. `MainWindow`: Ядро приложения

Это самый главный класс, связывающий все воедино.

-   **Сетевой слой:** Управляет экземпляром `QTcpSocket`. Отвечает за отправку (`sendJson`) и получение (`onReadyRead`) всех данных.
-   **Обработчик протокола:** Содержит `m_responseHandlers` (`QMap`), который сопоставляет строковые типы команд из JSON с методами-обработчиками (`handlePrivateMessage`, `handleUserList` и т.д.). Такая структура позволяет легко добавлять новые команды от сервера.
-   **Управление кэшем (V4):** Владеет `m_chatHistoryCache`. При переключении чата он сначала проверяет наличие истории в этом кэше и только в случае отсутствия отправляет запрос на сервер. Это ключевая оптимизация производительности.
-   **Управление состоянием:** Хранит всю глобальную информацию:
    -   `m_currentUsername`, `m_currentChatPartner`: кто сейчас залогинен и с кем открыт чат.
    -   `m_unreadCounts`: `QMap`, хранящая количество непрочитанных сообщений для каждого чата.
    -   `m_editingMessageId`, `m_replyToMessageId`: флаги, определяющие режим ввода (редактирование или ответ).
-   **Координатор UI:** Собирает главный интерфейс в `buildMainUI` и управляет переключением между `LoginWidget` и основным виджетом чата. Он принимает сигналы от UI-компонентов и вызывает их публичные методы для обновления.

### 3.2. Компоненты чата (`ChatViewWidget`, `SmoothListView`, `ChatMessageDelegate`, `ChatMessageModel`)

Это наиболее сложная и проработанная часть системы.

-   **`ChatViewWidget` (Представление/Контроллер UI):**
    -   Отвечает за визуальное представление одного чата.
    -   Содержит `SmoothListView` для отображения сообщений, `headerWidget` с информацией о собеседнике и `messageInputWidget` с полем ввода.
    -   **Новое в V4:** Управляет видимостью и состоянием `scrollToBottomButton` и `unreadCountLabel`, реагируя на прокрутку и получение новых сообщений.
    -   Не хранит никакой логики, кроме отображения. Все действия пользователя (отправка, запрос на редактирование) транслируются в `MainWindow` через сигналы.

-   **`SmoothListView` (Представление):**
    -   Кастомный класс, наследуемый от `QListView`.
    -   Его единственная задача — обеспечить плавную попиксельную прокрутку, улучшая пользовательский опыт.

-   **`ChatMessageModel` (Модель):**
    -   Хранит данные **только для текущего активного чата**.
    -   Содержит `QList` для последовательного доступа (требуется для View) и `QMap` для быстрого доступа по ID (требуется для `ChatMessageDelegate` при отрисовке ответов).
    -   **Новое в V4:** Реализует механизм "умной" отправки статуса "прочитано". Имеет слот `markMessageAsRead` и сигнал `messageNeedsReadReceipt`, создавая цепочку Делегат -> Модель -> `MainWindow`.

-   **`ChatMessageDelegate` (Представление/Отрисовка):**
    -   "Художник", отвечающий за рендеринг каждого сообщения.
    -   **Ключевая логика V4:** Именно делегат, в момент отрисовки сообщения (`paint()`), инициирует процесс пометки сообщения как прочитанного. Это гарантирует, что статус отправляется только тогда, когда пользователь физически видит сообщение.
    -   Берет на себя всю сложную геометрию: расчет размеров пузырей, отрисовку блоков цитат, метаданных (время, статусы) и обработку переноса длинных строк.

### 3.3. Компоненты списка контактов (`QListWidget`, `ContactListDelegate`)

-   **`QListWidget` (Представление):**
    -   Стандартный виджет для отображения списка контактов.
    -   `MainWindow` наполняет его данными из `m_userCache`.

-   **`ContactListDelegate` (Представление/Отрисовка V4):**
    -   Новый класс в версии 4.
    -   Его задача — кастомизировать отрисовку элементов `QListWidget`.
    -   В конструктор передается указатель на `m_unreadCounts` из `MainWindow`.
    -   При отрисовке каждого контакта он проверяет наличие непрочитанных сообщений и, если они есть, рисует поверх элемента круглый "бейдж" с их количеством.

### 3.4. Структуры данных (`structures.h`)

-   **`User` и `ChatMessage`:** Простые `struct`, определяющие модели данных. Они являются "единым языком", на котором общаются все компоненты системы.
-   **`ChatCache` (Новое в V4):** Структура, инкапсулирующая кэш одного чата: список его сообщений и флаги для управления пагинацией. Это ядро новой системы кэширования.

---

## 4. Итоги по архитектуре V4

Архитектура четвертой версии является зрелой, производительной и хорошо продуманной.

-   **Сильные стороны:**
    -   **Отзывчивость:** Благодаря кэшированию и асинхронности приложение ощущается очень быстрым.
    -   **Масштабируемость:** Структура с центральным контроллером и обработчиками команд позволяет легко добавлять новый функционал (например, групповые чаты, отправку файлов), не ломая существующую логику.
    -   **Надежность:** Четкое разделение ответственности и слабая связанность компонентов упрощают тестирование и отладку.
    -   **Качественный UX:** Внимание к деталям, таким как плавная прокрутка, счетчики непрочитанных и умные статусы, ставит приложение в один ряд с коммерческими продуктами.